\section{Architecture Design}
\label{sec:arch}

\tresumo{Arquitetura e Processo: Apresentação da topologia e do fluxo automatizado de deploy do cluster (Terraform -> Cloud-Init -> Ansible).}

\bnote{ATENÇÃO: As referências para as figuras fig:prov-terraform, fig:prov-os e fig:prov-cluster constam no texto mas as imagens não estão no arquivo latex inseridas com \texttt{\textbackslash begin\{figure\}}.}

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.9\linewidth]{content/assets/topology.png}
    \caption{Topology of Cloud Config on OCI.}
     \label{fig:topology}
\end{figure}

Figure~\ref{fig:prov-terraform} depicts the Terraform execution
perspective of the provisioning workflow. It covers RSA key-pair
generation, network resource creation (VCN, Internet Gateway, DRG,
Route Table, Security List), IPSec VPN configuration, compute
instance provisioning with cloud-init \texttt{user\_data}, and
the upload of Ansible playbooks and cluster assets to the master
node via SSH file provisioner.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=\linewidth]{content/assets/provisioning-01-terraform.png}
  \caption{Provisioning workflow — View 1: Terraform execution sequence.}
  \label{fig:prov-terraform}
\end{figure}

Figure~\ref{fig:prov-os} details the OS-level configuration phase,
triggered by cloud-init on all VMs immediately after boot. It
covers the concurrent execution on the master (Python/Ansible
installation, SSH key injection, Ansible inventory setup) and
workers (SELinux and firewall disabling, chrony), followed by
the full \texttt{site.yml} Ansible playbook: base package
installation, PostgreSQL initialisation, Ambari Server setup,
ODP repository configuration, and Ambari Agent deployment across
all cluster nodes.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=\linewidth]{content/assets/provisioning-02-os.png}
  \caption{Provisioning workflow — View 2: OS-level configuration
           via cloud-init and Ansible.}
  \label{fig:prov-os}
\end{figure}

Figure~\ref{fig:prov-cluster} shows the cluster deployment and
recovery flow, orchestrated by Ansible calling the Ambari REST
API (\texttt{cluster\_deploy.yml} and \texttt{deploy\_tasks.yml}).
The diagram covers the happy-path deployment (VDF registration,
blueprint upload, cluster creation, and progress polling) and the
automated recovery logic supporting up to three sequential retry
attempts, each preceded by HDFS corrections and Hive database
reconfiguration, with a final fallback to manual service
initialisation (\texttt{manual\_service\_init.sh}).

\begin{figure}[htbp]
  \centering
  \includegraphics[width=\linewidth]{content/assets/provisioning-03-cluster.png}
  \caption{Provisioning workflow — View 3: Ambari REST API cluster
           deployment with automated recovery logic.}
  \label{fig:prov-cluster}
\end{figure}
\subsection{Data Lake Installation Profiles}
The cluster provisioning process supports different deployment profiles customised for specific workloads. Based on the selected profile, Ambari will distribute the adequate components across the cluster nodes. The tables below detail the components present and the host responsibilities for each profile.

\begin{table}[htbp]
  \centering
  \caption{Component Mapping for the Default Profile}
  \label{tab:comp-default}
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{l p{10cm}}
    \hline
    \textbf{Node \& Role} & \textbf{Installed Components} \\
    \hline
    \textbf{master.cdp (10.0.0.2)} & Ambari Server, App Timeline Server, HBase Client, HBase Master, HDFS Client, HistoryServer, Hive Client, Infra Solr, Infra Solr Client, MapReduce2 Client, NameNode, Phoenix Query Server, Ranger Admin, Ranger UserSync, ResourceManager, Secondary NameNode, Spark 3 Client, Spark 3 JobHistoryServer, Tez Client, Timeline Reader, YARN Client, YARN Registry DNS, ZooKeeper Client, ZooKeeper Server \\
    \textit{Master Node (Cluster Management, Core Masters)} & \\
    \hline
    \textbf{node1.cdp (10.0.0.3)} & DataNode, HBase Client, HDFS Client, Hive Client, Hive Metastore, Hive Server, Infra Solr Client, Kafka Broker, MapReduce2 Client, NFS Gateway, NiFi CA, NiFi Master, NodeManager, Spark 3 Client, Tez Client, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 1 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node2.cdp (10.0.0.4)} & DataNode, HBase Client, HDFS Client, Hive Client, Infra Solr Client, Kafka Broker, MapReduce2 Client, NodeManager, Spark 3 Client, Spark 3 ThriftServer, Tez Client, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 2 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node3.cdp (10.0.0.5)} & DataNode, HBase Client, HBase RegionServer, HDFS Client, Hive Client, Infra Solr Client, Kafka Broker, MapReduce2 Client, NodeManager, Ranger TagSync, Spark 3 Client, Spark 3 Livy2 Server, Tez Client, YARN Client, ZooKeeper Client \\
    \textit{Worker Node 3 (Data/Compute, specialized services)} & \\
    \hline
  \end{tabular}
\end{table}

\begin{table}[htbp]
  \centering
  \caption{Component Mapping for the Data Science Profile}
  \label{tab:comp-data-science}
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{l p{10cm}}
    \hline
    \textbf{Node \& Role} & \textbf{Installed Components} \\
    \hline
    \textbf{master.cdp (10.0.0.2)} & App Timeline Server, HDFS Client, HistoryServer, Hive Client, Infra Solr, Infra Solr Client, MapReduce2 Client, NameNode, Ranger Admin, Ranger UserSync, ResourceManager, Secondary NameNode, Spark 3 Client, Spark 3 JobHistoryServer, Tez Client, Timeline Reader, YARN Client, YARN Registry DNS, ZooKeeper Client, ZooKeeper Server \\
    \textit{Master Node (Cluster Management, Core Masters)} & \\
    \hline
    \textbf{node1.cdp (10.0.0.3)} & DataNode, HDFS Client, Hive Client, Hive Metastore, Hive Server, Infra Solr Client, Kafka Broker, MapReduce2 Client, NFS Gateway, NodeManager, Spark 3 Client, Tez Client, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 1 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node2.cdp (10.0.0.4)} & DataNode, HDFS Client, Hive Client, Infra Solr Client, Kafka Broker, MapReduce2 Client, NodeManager, Spark 3 Client, Spark 3 ThriftServer, Tez Client, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 2 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node3.cdp (10.0.0.5)} & DataNode, HDFS Client, Hive Client, Infra Solr Client, Kafka Broker, MapReduce2 Client, NodeManager, Ranger TagSync, Spark 3 Client, Spark 3 Livy2 Server, Tez Client, YARN Client, ZooKeeper Client \\
    \textit{Worker Node 3 (Data/Compute, specialized services)} & \\
    \hline
  \end{tabular}
\end{table}

\begin{table}[htbp]
  \centering
  \caption{Component Mapping for the Software Engineering Profile}
  \label{tab:comp-software-engineering}
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{l p{10cm}}
    \hline
    \textbf{Node \& Role} & \textbf{Installed Components} \\
    \hline
    \textbf{master.cdp (10.0.0.2)} & App Timeline Server, HBase Client, HBase Master, HDFS Client, HistoryServer, Infra Solr, MapReduce2 Client, NameNode, Phoenix Query Server, ResourceManager, Secondary NameNode, Timeline Reader, YARN Client, YARN Registry DNS, ZooKeeper Client, ZooKeeper Server \\
    \textit{Master Node (Cluster Management, Core Masters)} & \\
    \hline
    \textbf{node1.cdp (10.0.0.3)} & DataNode, HBase Client, HDFS Client, MapReduce2 Client, NFS Gateway, NiFi CA, NodeManager, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 1 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node2.cdp (10.0.0.4)} & DataNode, HBase Client, HDFS Client, MapReduce2 Client, NiFi Master, NodeManager, YARN Client, ZooKeeper Client, ZooKeeper Server \\
    \textit{Worker Node 2 (Data/Compute, specialized services)} & \\
    \hline
    \textbf{node3.cdp (10.0.0.5)} & DataNode, HBase Client, HBase RegionServer, HDFS Client, Kafka Broker, MapReduce2 Client, NodeManager, YARN Client, ZooKeeper Client \\
    \textit{Worker Node 3 (Data/Compute, specialized services)} & \\
    \hline
  \end{tabular}
\end{table}

