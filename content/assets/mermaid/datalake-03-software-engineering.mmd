%%{init: {"theme": "base", "themeVariables": {"primaryColor": "#0a1628", "primaryTextColor": "#e0e0e0", "primaryBorderColor": "#00b894", "lineColor": "#00b894", "secondaryColor": "#00423a", "tertiaryColor": "#001a17", "clusterBkg": "#0d1117", "clusterBorder": "#00b894", "edgeLabelBackground": "#0a1628", "fontFamily": "Segoe UI, sans-serif"}}}%%
graph TB
    %% =========================================================
    %%  Data Lake Architecture — Profile: SOFTWARE-ENGINEERING
    %%  Cluster: 1 Master Node + 3 Worker Nodes (OCI ARM / Ampere)
    %%  Stack: ODP 1.2.2 managed by Apache Ambari
    %%  Focus: Real-time data pipelines, API integration & NoSQL
    %%  Highlights: NiFi (orchestration), HBase (NoSQL), Kafka (streaming)
    %%  Removed vs default: Hive, Spark analytics, Ranger, Tez
    %% =========================================================

    subgraph INGEST["① INGESTION LAYER"]
        direction TB
        KAFKA["Apache Kafka\n(Broker on node3)\nEvent streaming & message bus\nMicroservice decoupling point"]
        NIFI_CA["NiFi Certificate Authority\n(node1)\nTLS certificate management\nSecures NiFi cluster communication"]
        NIFI["Apache NiFi\n(Master on node2)\nVisual data flow designer\nREST API pulls · DB replication\nEvent-driven ETL to HDFS / HBase"]
        NIFI_CA -->|"issues TLS certs to"| NIFI
        KAFKA   -->|"consumed by"| NIFI
    end

    subgraph STORE["② STORAGE LAYER"]
        direction TB
        HDFS["HDFS — Hadoop Distributed File System\nNameNode (master) · 3× DataNode (node1·2·3)\nReplication factor 3\nRaw file & intermediate pipeline storage"]
        HBASE["Apache HBase\n(Master on master · RegionServer on node3)\nLow-latency columnar NoSQL store\nKey-value & time-series data at scale"]
        PHOENIX["Phoenix Query Server\n(master)\nSQL layer over HBase\nJDBC / ODBC API compatibility\nApplication integration point"]
        NFS["NFS Gateway\n(node1)\nPOSIX-compliant HDFS access\nLegacy application data transfer"]
        HDFS --> HBASE
        HBASE --> PHOENIX
    end

    subgraph PROCESS["③ PROCESSING LAYER"]
        direction TB
        YARN["Apache YARN / MapReduce 2\nResourceManager (master) · 3× NodeManager\nBatch job scheduling & resource quotas"]
        MR2["MapReduce 2\n(clients on all nodes)\nBatch ETL pipelines\nHeavy transformation workloads"]
        YARN --> MR2
    end

    subgraph GOVERN["④ COORDINATION & OBSERVABILITY LAYER"]
        direction TB
        ZK["Apache ZooKeeper\n(node1·2·3)\nDistributed coordination\nHBase & Kafka leader election\nNiFi cluster state management"]
        SOLR["Infra Solr\n(master)\nService metadata indexing\nAmbari metrics backend"]
        AMBARI["Apache Ambari Server\n(master)\nCluster lifecycle management\nService health monitoring & alerting"]
        AMBARI -.->|"manages"| ZK
        ZK --> SOLR
    end

    %% Cross-layer flows
    INGEST -->|"data flows written to"| STORE
    STORE  -->|"data read by batch jobs"| PROCESS
    GOVERN -.->|"coordinates"| INGEST
    GOVERN -.->|"coordinates"| STORE
    GOVERN -.->|"coordinates"| PROCESS

    %% External application integration
    APP["Application Client\nMicroservice / REST API\nExternal system integration"]
    APP -->|"produce events to"| KAFKA
    APP -->|"query via JDBC"| PHOENIX

    %% Infrastructure anchor
    subgraph INFRA["⑤ INFRASTRUCTURE (OCI ARM — Ampere A1 Flex)"]
        direction LR
        MASTER["master.cdp — 10.0.0.2\nNameNode · ResourceManager · Ambari Server\nHBase Master · Phoenix Q. Server · Infra Solr"]
        N1["node1.cdp — 10.0.0.3\nDataNode · NodeManager · ZooKeeper\nNiFi CA · NFS Gateway · HBase Client"]
        N2["node2.cdp — 10.0.0.4\nDataNode · NodeManager · ZooKeeper\nNiFi Master (flow designer UI & REST)"]
        N3["node3.cdp — 10.0.0.5\nDataNode · NodeManager · ZooKeeper\nKafka Broker · HBase RegionServer"]
    end

    PROCESS -.->|"runs on"| INFRA
    STORE   -.->|"runs on"| INFRA
    INGEST  -.->|"runs on"| INFRA

    %% Styling
    classDef ingestStyle   fill:#001a17,stroke:#00e5c0,color:#e0e0e0,rx:6
    classDef storeStyle    fill:#001428,stroke:#74b9ff,color:#e0e0e0,rx:6
    classDef processStyle  fill:#0d1117,stroke:#55efc4,color:#e0e0e0,rx:6
    classDef governStyle   fill:#1a1a2e,stroke:#ffeaa7,color:#e0e0e0,rx:6
    classDef infraStyle    fill:#2d2d2d,stroke:#00b894,color:#dfe6e9,rx:4
    classDef appStyle      fill:#2d3436,stroke:#fd79a8,color:#dfe6e9,rx:8

    class KAFKA,NIFI,NIFI_CA ingestStyle
    class HDFS,HBASE,PHOENIX,NFS storeStyle
    class YARN,MR2 processStyle
    class ZK,SOLR,AMBARI governStyle
    class MASTER,N1,N2,N3 infraStyle
    class APP appStyle
