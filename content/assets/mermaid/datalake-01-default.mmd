%%{init: {"theme": "base", "themeVariables": {"primaryColor": "#1a1a2e", "primaryTextColor": "#e0e0e0", "primaryBorderColor": "#4a90e2", "lineColor": "#4a90e2", "secondaryColor": "#16213e", "tertiaryColor": "#0f3460", "clusterBkg": "#0d1117", "clusterBorder": "#4a90e2", "edgeLabelBackground": "#1a1a2e", "fontFamily": "Segoe UI, sans-serif"}}}%%
graph TB
    %% =========================================================
    %%  Data Lake Architecture — Profile: DEFAULT
    %%  Cluster: 1 Master Node + 3 Worker Nodes (OCI ARM / Ampere)
    %%  Stack: ODP 1.2.2 managed by Apache Ambari
    %%  Full-featured profile: Ingest · Store · Process · Govern
    %% =========================================================

    subgraph INGEST["① INGESTION LAYER"]
        direction TB
        KAFKA["Apache Kafka\n(Brokers on node1·2·3)\nReal-time event streaming"]
        NIFI["Apache NiFi\n(Master on node1)\nData flow & ETL pipelines"]
        NFS["NFS Gateway\n(node1)\nBatch / POSIX file ingest"]
        KAFKA -->|"topics feed"| NIFI
    end

    subgraph STORE["② STORAGE LAYER"]
        direction TB
        HDFS["HDFS — Hadoop Distributed File System\nNameNode (master) · 3× DataNode (node1·2·3)\nReplication factor 3 — AARCH64 block storage"]
        HBASE["Apache HBase\n(Master on master · RegionServer on node3)\nColumnar NoSQL store over HDFS"]
        HIVE_META["Apache Hive Metastore\n(node1)\nCentral schema registry (tables, partitions)"]
        HDFS --> HBASE
        HDFS --> HIVE_META
    end

    subgraph PROCESS["③ PROCESSING LAYER"]
        direction TB
        YARN["Apache YARN / MapReduce 2\nResourceManager (master) · 3× NodeManager\nDistributed resource scheduler"]
        SPARK["Apache Spark 3\nJobHistoryServer (master) · ThriftServer (node2)\nLivy2 Server (node3) · Clients on all nodes\nIn-memory batch & streaming compute"]
        TEZ["Apache Tez\n(clients on all nodes)\nDAG execution engine for Hive queries"]
        HIVE_SRV["Apache Hive Server 2\n(node1)\nSQL interface — HiveQL over Tez/Spark"]
        PHOENIX["Phoenix Query Server\n(master)\nSQL over HBase (JDBC/ODBC)"]
        YARN --> SPARK
        YARN --> TEZ
        TEZ --> HIVE_SRV
        SPARK --> HIVE_SRV
        PHOENIX --> HBASE
    end

    subgraph GOVERN["④ GOVERNANCE & SECURITY LAYER"]
        direction TB
        RANGER["Apache Ranger\n(Admin + UserSync on master · TagSync on node3)\nCentralised RBAC & audit policies"]
        ZK["Apache ZooKeeper\n(node1·2·3)\nDistributed coordination & leader election"]
        SOLR["Infra Solr\n(master)\nAudit log indexing backend for Ranger"]
        AMBARI["Apache Ambari Server\n(master)\nCluster management & monitoring UI"]
        RANGER --> SOLR
        ZK --> RANGER
        AMBARI -.->|"manages all services"| ZK
    end

    %% Cross-layer data flows
    INGEST -->|"raw events & files written to"| STORE
    STORE  -->|"data read by compute jobs"| PROCESS
    GOVERN -.->|"policies enforced across"| INGEST
    GOVERN -.->|"policies enforced across"| STORE
    GOVERN -.->|"policies enforced across"| PROCESS

    %% Infrastructure anchor
    subgraph INFRA["⑤ INFRASTRUCTURE (OCI ARM — Ampere A1 Flex)"]
        direction LR
        MASTER["master.cdp — 10.0.0.2\nAnsible Controller · NameNode · ResourceManager\nAmbari Server · Ranger · Spark HistoryServer"]
        N1["node1.cdp — 10.0.0.3\nDataNode · NodeManager · Kafka Broker\nHive Metastore / Server · NiFi · NFS Gateway"]
        N2["node2.cdp — 10.0.0.4\nDataNode · NodeManager · Kafka Broker\nSpark ThriftServer"]
        N3["node3.cdp — 10.0.0.5\nDataNode · NodeManager · Kafka Broker\nHBase RegionServer · Spark Livy2 · Ranger TagSync"]
    end

    PROCESS -.->|"runs on"| INFRA
    STORE   -.->|"runs on"| INFRA
    INGEST  -.->|"runs on"| INFRA

    %% Styling
    classDef ingestStyle  fill:#0f3460,stroke:#e94560,color:#fff,rx:6
    classDef storeStyle   fill:#16213e,stroke:#4a90e2,color:#fff,rx:6
    classDef processStyle fill:#0d1117,stroke:#00d2d3,color:#fff,rx:6
    classDef governStyle  fill:#1a1a2e,stroke:#f9ca24,color:#fff,rx:6
    classDef infraStyle   fill:#2d2d2d,stroke:#a29bfe,color:#dfe6e9,rx:4

    class KAFKA,NIFI,NFS ingestStyle
    class HDFS,HBASE,HIVE_META storeStyle
    class YARN,SPARK,TEZ,HIVE_SRV,PHOENIX processStyle
    class RANGER,ZK,SOLR,AMBARI governStyle
    class MASTER,N1,N2,N3 infraStyle
